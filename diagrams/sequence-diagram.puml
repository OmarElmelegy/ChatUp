@startuml ChatSystem Sequence Diagram

skinparam sequenceMessageAlign center
skinparam backgroundColor #FFFFFF
skinparam shadowing false
skinparam linetype ortho

actor "User 1" as User1
participant "ChatClient 1" as Client1
participant "ServerListener 1" as Listener1
participant ChatServer
participant "ClientHandler 1" as Handler1
participant DatabaseManager
participant "ClientHandler 2" as Handler2
participant "ServerListener 2" as Listener2
participant "ChatClient 2" as Client2
actor "User 2" as User2

== Connection Phase ==
User1 -> Client1: Start application
Client1 -> Client1: Load SSL truststore
Client1 -> ChatServer: **SSL Handshake**
note right: Establish encrypted connection
ChatServer -> ChatServer: Load SSL keystore
ChatServer -> Client1: SSL handshake complete
Client1 -> ChatServer: Connect via SSL/TLS (port 5001)
ChatServer -> Handler1: Create ClientHandler
ChatServer -> Handler1: Start thread
activate Handler1

Client1 -> User1: Prompt for username
User1 -> Client1: Enter "Alice"
Client1 -> Handler1: Send "Alice" (encrypted)
Handler1 -> Handler1: Register username
Handler1 -> Client1: "Welcome, Alice!" (encrypted)
Handler1 -> ChatServer: broadcast("Alice joined")

Client1 -> Listener1: Start listener thread
activate Listener1

User2 -> Client2: Start application
Client2 -> Client2: Load SSL truststore
Client2 -> ChatServer: **SSL Handshake**
note right: Establish encrypted connection
ChatServer -> Client2: SSL handshake complete
Client2 -> ChatServer: Connect via SSL/TLS (port 5001)
ChatServer -> Handler2: Create ClientHandler
ChatServer -> Handler2: Start thread
activate Handler2

Client2 -> User2: Prompt for username
User2 -> Client2: Enter "Bob"
Client2 -> Handler2: Send "Bob" (encrypted)
Handler2 -> Handler2: Register username
Handler2 -> DatabaseManager: getAllMessages()
DatabaseManager -> Handler2: Return message history
Handler2 -> Client2: Send message history (encrypted)
Handler2 -> Client2: "Welcome, Bob!" (encrypted)
Handler2 -> Handler1: broadcast("Bob joined")
Handler1 -> Listener1: "SERVER: Bob joined" (encrypted)
Listener1 -> User1: Display "Bob joined"

Client2 -> Listener2: Start listener thread
activate Listener2

== Public Message ==
User1 -> Client1: Type "Hello everyone"
Client1 -> Handler1: Send "Hello everyone" (encrypted)
note right: All messages encrypted via SSL
Handler1 -> DatabaseManager: insertMessage("Alice", "Hello everyone", timestamp)
DatabaseManager -> DatabaseManager: Store in chat.db
Handler1 -> Handler2: broadcast("Alice: Hello everyone")
Handler2 -> Listener2: Send message (encrypted)
Listener2 -> User2: Display "Alice: Hello everyone"

== Private Message ==
User2 -> Client2: Type "/w Alice Hi there!"
Client2 -> Handler2: Send "/w Alice Hi there!" (encrypted)
Handler2 -> Handler1: sendPrivateMessage()
Handler1 -> Listener1: "Bob (Whisper): Hi there!" (encrypted)
Listener1 -> User1: Display whisper
Handler2 -> Listener2: "You whispered to Alice: Hi there!" (encrypted)
Listener2 -> User2: Display confirmation

== List Users ==
User1 -> Client1: Type "/list"
Client1 -> Handler1: Send "/list" (encrypted)
Handler1 -> Handler1: Get all users
Handler1 -> Listener1: Send user list (encrypted)
Listener1 -> User1: Display "[Alice, Bob]"

== File Transfer ==
User1 -> Client1: Click "File" button
Client1 -> Client1: Open file chooser
User1 -> Client1: Select file "document.pdf"
Client1 -> Handler1: Send msgType_FILE + filename + size + data (encrypted)
note right: File sent in 8KB chunks\nBackground thread prevents UI freeze
Handler1 -> Handler1: Validate file size (<50MB)
Handler1 -> DatabaseManager: insertMessage("Alice", "[File: document.pdf]", timestamp)
DatabaseManager -> DatabaseManager: Store file reference in chat.db
Handler1 -> Handler2: broadcastFile(filename, data)
Handler2 -> Listener2: Send msgType_FILE + filename + size + data (encrypted)
Listener2 -> User2: Open save dialog
User2 -> Client2: Choose save location
Client2 -> Client2: Write file to disk
Listener2 -> User2: Display "Saved file to path"

== Disconnection ==
User2 -> Client2: Type "bye"
Client2 -> Handler2: Send "bye" (encrypted)
Handler2 -> Handler2: Exit loop
Handler2 -> ChatServer: removeClient(Handler2)
Handler2 -> Handler1: broadcast("Bob left")
Handler1 -> Listener1: "SERVER: Bob left" (encrypted)
Listener1 -> User1: Display "Bob left"
Handler2 -> Client2: Close SSL connection
deactivate Handler2
deactivate Listener2

@enduml
